-- 1. Reference Data (Channels)
-- CHANGE: 'BIGINT AUTO_INCREMENT' -> 'NUMBER GENERATED BY DEFAULT AS IDENTITY'
-- CHANGE: 'VARCHAR' -> 'VARCHAR2' (Oracle Standard)
CREATE TABLE ref_notification_channels (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    channel_name VARCHAR2(50) NOT NULL,
    monthly_cost NUMBER(10,2) DEFAULT 0.00
);
SELECT this_.id, this_.channel_name, this_.monthly_cost
FROM ref_notification_channels this_
ORDER BY this_.channel_name ASC
-- Insert static data
INSERT INTO ref_notification_channels (channel_name, monthly_cost) VALUES ('SMS_ALERT', 1.00);
INSERT INTO ref_notification_channels (channel_name, monthly_cost) VALUES ('EMAIL_STMT', 0.00);
INSERT INTO ref_notification_channels (channel_name, monthly_cost) VALUES ('WHATSAPP_OTP', 2.50);
COMMIT;
-- 2. KYC Profiles
CREATE TABLE kyc_profiles (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    pan_number VARCHAR2(20) UNIQUE,
    risk_status VARCHAR2(20)
);

-- 3. Customers
CREATE TABLE customers (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(100),
    email VARCHAR2(100),
    kyc_id NUMBER UNIQUE,
    CONSTRAINT fk_cust_kyc FOREIGN KEY (kyc_id) REFERENCES kyc_profiles(id)
);

-- 4. Accounts
CREATE TABLE accounts (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    account_number VARCHAR2(20) UNIQUE NOT NULL,
    balance NUMBER(19,2),
    customer_id NUMBER,
    version NUMBER DEFAULT 0, -- For Optimistic Locking
    CONSTRAINT fk_acc_cust FOREIGN KEY (customer_id) REFERENCES customers(id)
);

-- 5. Transactions (The Ledger)
CREATE TABLE bank_transactions (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tx_date DATE,
    type VARCHAR2(10), -- CREDIT/DEBIT
    amount NUMBER(19,2),
    status VARCHAR2(20),
    account_id NUMBER,
    CONSTRAINT fk_tx_acc FOREIGN KEY (account_id) REFERENCES accounts(id)
);

-- 6. Subscriptions (Join Table)
CREATE TABLE account_subscriptions (
    account_id NUMBER,
    channel_id NUMBER,
    CONSTRAINT pk_subs PRIMARY KEY (account_id, channel_id),
    CONSTRAINT fk_sub_acc FOREIGN KEY (account_id) REFERENCES accounts(id),
    CONSTRAINT fk_sub_chan FOREIGN KEY (channel_id) REFERENCES ref_notification_channels(id)
);


-- Oracle Sequence Creation Script
-- Execute these statements in your Oracle database to create the sequences
-- required for entity ID generation

-- Sequence for Customer table
CREATE SEQUENCE CUSTOMER_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Sequence for Account table
CREATE SEQUENCE ACCOUNT_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Sequence for KYC Profile table
CREATE SEQUENCE KYC_PROFILE_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Sequence for Bank Transaction table
CREATE SEQUENCE BANK_TRANSACTION_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Sequence for Reference Notification Channel table
CREATE SEQUENCE REF_NOTIFICATION_CHANNEL_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Optional: If you already have data in the tables, set the sequence start value
-- to be higher than the maximum existing ID value. Example:
-- ALTER SEQUENCE CUSTOMER_SEQ RESTART WITH 1000;

-- Verify sequences were created successfully
SELECT sequence_name, last_number 
FROM user_sequences 
WHERE sequence_name IN (
    'CUSTOMER_SEQ',
    'ACCOUNT_SEQ', 
    'KYC_PROFILE_SEQ',
    'BANK_TRANSACTION_SEQ',
    'REF_NOTIFICATION_CHANNEL_SEQ'
);
